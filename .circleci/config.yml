version: 2.1

aliases:
  - &docker_image circleci/node:8.11.3
  - &dev_s3_bucket ledger-vault-artifacts-dev
  - &prod_s3_bucket ledger-vault-artifacts-prod
  - &common_filters
    tags:
      only: /.*/
  - &prod_filters
    branches:
      only: master
    tags:
      only: /.*/

jobs:
  run_tests:
    description: Build project
    docker:
      - image: *docker_image
    steps:
      - checkout
      - restore_cache:
          keys:
            - node-v2-{{ .Branch }}-{{ checksum "package-lock.json" }}
            - node-v2-{{ .Branch }}-
            - node-v2-
      - run:
          name: Install dependencies
          command: npm install
      - save_cache:
          key: node-v2-{{ .Branch }}-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
      - run: npm run lint
      - run: ./node_modules/.bin/prettier -l "{src,webpack,test,cypress}/**/*.{js,json}"
      - run: npm run flow
      - run: npm run test
  build:
    description: Build project
    docker:
      - image: *docker_image
    steps:
      - checkout
      - restore_cache:
          keys:
            - node-v2-{{ .Branch }}-{{ checksum "package-lock.json" }}
      - run:
          name: Build project
          command: npm run build
      - run:
          name: Create workspace
          command: mkdir -pv ~/workspace
      - run:
          name: Create a archive containing all the artifacts
          command: tar -czvf ~/workspace/ledger-vault-front.tar.gz -C dist .
      - persist_to_workspace:
          root: ~/workspace
          paths:
            - ledger-vault-front.tar.gz
      - store_artifacts:
          path: ~/workspace
          destination: artifacts

  publish:
    description: Publish artifact on CircleCI and on S3
    parameters:
      s3_bucket:
        description: Bucket where artifacts will be stored
        type: string
      access_key:
        type: env_var_name
      secret_key:
        type: env_var_name
    docker:
      - image: *docker_image
    steps:
      - run:
          name: Install AWS CLI
          command: |
            sudo apt-get -q=2 update
            sudo apt-get -q=2 install awscli
      - attach_workspace:
          at: ~/workspace
      - run:
          name: Set up AWS credentials
          command: |
            eval echo 'export AWS_ACCESS_KEY_ID="${<< parameters.access_key >>}"' >> $BASH_ENV
            eval echo 'export AWS_SECRET_ACCESS_KEY="${<< parameters.secret_key >>}"' >> $BASH_ENV
      - run:
          name: Upload on AWS S3
          command: |
            s3_path="s3://<< parameters.s3_bucket >>/ledger-vault-front"
            artifact_with_sha1="ledger-vault-front_${CIRCLE_SHA1}.tar.gz"
            aws s3 cp --no-progress ~/workspace/ledger-vault-front.tar.gz ${s3_path}/${artifact_with_sha1}
            latest=$(mktemp)
            echo $artifact_with_sha1 > $latest
            aws s3 cp --no-progress $latest ${s3_path}/LATEST
            rm -f $latest

workflows:
  build_publish:
    jobs:
      - run_tests:
          filters: *common_filters
      - build:
          requires:
            - run_tests
          filters: *common_filters
      - publish:
          name: publish_dev
          s3_bucket: *dev_s3_bucket
          access_key: AWS_ACCESS_KEY_ID_DEV
          secret_key: AWS_SECRET_ACCESS_KEY_DEV
          requires:
            - build
          filters: *common_filters
      - publish:
          name: publish_prod
          s3_bucket: *prod_s3_bucket
          access_key: AWS_ACCESS_KEY_ID_PROD
          secret_key: AWS_SECRET_ACCESS_KEY_PROD
          requires:
            - build
          filters: *prod_filters
